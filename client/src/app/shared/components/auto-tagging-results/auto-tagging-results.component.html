<div class="flex flex-col gap-3">
  <!-- Header -->
  <div class="flex items-center gap-2">
    <span class="text-xs uppercase font-bold tracking-wider text-text-dim">Auto-Tagging</span>
    @if (status() === 'failed') {
    <span class="text-xs text-status-error">Failed</span>
    }
  </div>

  <!-- Per-provider buttons -->
  @if (showProviderButtons() && providers().length > 0) {
  <div class="flex flex-wrap gap-2 pb-2 border-b border-white/5">
    @for (provider of providers(); track provider.id) {
    <app-button variant="secondary" size="sm" (click)="onRunProvider(provider.id)" [disabled]="status() === 'tagging'">
      Run {{ provider.name }}
    </app-button>
    }
  </div>
  }

  <!-- General loading state (when tagging without specific provider) -->
  @if (status() === 'tagging' && !loadingProvider()) {
  <div class="flex flex-col gap-3 p-3 bg-white/5 rounded border border-white/5">
    <div class="flex items-center justify-center py-6">
      <div class="flex flex-col items-center gap-2 text-text-muted">
        @if (activeBackoff(); as backoff) {
        <!-- Throttled state -->
        <svg class="h-5 w-5 text-status-warning" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="text-sm text-status-warning">Rate limited by {{ backoff.apiId }}</span>
        <span class="text-xs">Retrying in {{ (backoff.waitMs / 1000) | number:'1.0-0' }}s</span>
        } @else {
        <!-- Normal loading state -->
        <svg class="animate-spin h-5 w-5 text-accent-primary" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        <span class="text-sm">Analyzing image...</span>
        }
      </div>
    </div>
  </div>
  }

  <!-- Loading specific provider box -->
  @if (loadingProvider(); as provider) {
  <div class="flex flex-col gap-3 p-3 bg-white/5 rounded border border-white/5">
    <span class="text-xs text-text-muted italic">{{ provider.name }}</span>
    <div class="flex items-center justify-center py-6">
      <div class="flex items-center gap-3 text-text-muted">
        <svg class="animate-spin h-5 w-5 text-accent-primary" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        <span class="text-sm">Analyzing...</span>
      </div>
    </div>
  </div>
  }

  <!-- Results - shown even while tagging if we have previous results -->
  @if (displayResults().length > 0) {
  <div class="flex flex-col gap-3">
    @for (result of displayResults(); track result.providerId) {
    <div class="flex flex-col gap-3 p-3 bg-white/5 rounded border border-white/5">
      <!-- Provider name -->
      <span class="text-xs text-text-muted italic">{{ result.provider }}</span>

      <!-- Tags section -->
      <div class="flex flex-col gap-2">
        <span class="text-xs uppercase tracking-wider text-text-dim font-medium">Tags</span>
        @if (result.categorizedTags.length > 0) {
        <div class="flex flex-wrap gap-1.5">
          @for (tag of sortedTags(result.categorizedTags); track tag.name) {
          <span class="px-2 py-1 text-xs bg-white/5 rounded text-text-secondary border border-white/10">
            @if (tag.category && tag.category !== 'general') {
            <span class="text-accent-primary font-semibold">{{ tag.category }}:</span>
            }
            {{ tag.name }}
          </span>
          }
        </div>
        <app-button variant="primary" size="sm" (click)="onApplyTags(result.providerId)">
          Add tags ({{ result.categorizedTags.length }})
        </app-button>
        } @else {
        <span class="text-sm text-text-muted">No tags found</span>
        }
      </div>

      <!-- Sources section -->
      <div class="flex flex-col gap-2">
        <span class="text-xs uppercase tracking-wider text-text-dim font-medium">Sources</span>
        @if (result.sources && result.sources.length > 0) {
        <div class="flex flex-col gap-1">
          @for (source of result.sources; track source) {
          <a [href]="source" target="_blank" class="text-sm text-accent-primary hover:underline truncate">{{ source
            }}</a>
          }
        </div>
        <app-button variant="primary" size="sm" (click)="onApplySources(result.providerId)">
          Add sources ({{ result.sources.length }})
        </app-button>
        } @else {
        <span class="text-sm text-text-muted">No sources found</span>
        }
      </div>

      <!-- Safety section -->
      @if (result.safety) {
      <div class="flex flex-col gap-2">
        <span class="text-xs uppercase tracking-wider text-text-dim font-medium">Safety</span>
        <span
          class="px-2 py-1 text-xs bg-white/5 rounded text-text-secondary border border-white/10 w-fit capitalize cursor-pointer hover:bg-white/10 transition-colors"
          (click)="onApplySafety(result.providerId)">
          {{ result.safety }}
        </span>
      </div>
      }
    </div>
    }
  </div>
  } @else if (status() === 'completed' && !loadingProvider()) {
  <span class="text-sm text-text-muted">No suggestions found.</span>
  }
</div>